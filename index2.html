<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Signal Dashboard</title>

<link rel="icon" type="image/png" href="logo_icon.png">
<link rel="shortcut icon" href="favicon.ico">

<meta name="description" content="AI Signal Dashboard for Forex, Crypto, and Commodities with EMA, RSI, MACD indicators.">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#e5e7eb}
header{background:#020617;padding:15px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
select,button,input{padding:8px;border-radius:6px;border:none}
button{background:#2563eb;color:white;cursor:pointer}
button.secondary{background:#334155}
#signals{padding:20px}
.signal{background:#020617;padding:20px;border-radius:12px;max-width:420px;margin:auto;position:relative}
.vip-badge{position:absolute;top:10px;right:10px;background:#22c55e;color:#fff;padding:4px 8px;border-radius:8px;font-weight:bold;font-size:.9rem}
.buy{color:#22c55e}.sell{color:#ef4444}.hold{color:#9ca3af}
.vip-lock{filter:blur(7px);pointer-events:none}
#authBox{display:flex;gap:6px;flex-wrap:wrap}
#tidBox{display:none;flex-direction:column;gap:6px;margin-top:10px;background:#1e293b;padding:12px;border-radius:10px}
#vipTimer{margin-left:10px;font-weight:bold;color:#22c55e}
#chart{margin:20px auto;max-width:900px}
</style>
</head>

<body>

<header>
  <div>
    <h3>ðŸ“Š AI Signal Dashboard</h3>
    <select id="symbol">
      <option value="XAU/USD">XAU/USD</option>
      <option value="EUR/USD">EUR/USD (Free)</option>
      <option value="GBP/USD">GBP/USD (Free)</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="BTC/USD">BTC/USD</option>
    </select>
  </div>

  <div id="authBox">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn" class="secondary">Register</button>
    <button id="upgradeBtn" class="secondary" style="display:none;">Request VIP</button>

    <div id="tidBox">
      <p style="color:#fbbf24;margin:0">
        Send 5k UGX â†’ 0748244415 then enter TID
      </p>
      <input id="tidInput" placeholder="TID 123456789012">
      <button id="activateVipBtn" style="background:#22c55e">Activate VIP</button>
    </div>

    <div id="vipTimer"></div>
  </div>
</header>

<div id="chart"></div>
<div id="signals">Loadingâ€¦</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= CONFIG ================= */
const TWELVE_KEY="894c1cdec16d47b98980a4423f254352";
const INTERVAL="5min";
const freeSymbols=["EUR/USD","GBP/USD"];

/* ================= FIREBASE ================= */
const app=initializeApp({
  apiKey:"AIzaSyB1G6DhAZv70YLk65ESgZl0Cm1BHzab4a0",
  authDomain:"buddydownloads-72e3b.firebaseapp.com",
  databaseURL:"https://buddydownloads-72e3b-default-rtdb.firebaseio.com"
});
const auth=getAuth(app);
const db=getDatabase(app);

/* ================= DOM ================= */
const email=document.getElementById("email");
const password=document.getElementById("password");
const loginBtn=document.getElementById("loginBtn");
const registerBtn=document.getElementById("registerBtn");
const upgradeBtn=document.getElementById("upgradeBtn");
const tidBox=document.getElementById("tidBox");
const tidInput=document.getElementById("tidInput");
const activateVipBtn=document.getElementById("activateVipBtn");
const vipTimerDiv=document.getElementById("vipTimer");
const symbol=document.getElementById("symbol");
const signals=document.getElementById("signals");
const chartContainer=document.getElementById("chart");

let isVIP=false;
let vipCountdownInterval=null;

/* ================= INDICATORS ================= */
const EMA=(v,p)=>{let k=2/(p+1),e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
const RSI=(v,p=7)=>{let g=0,l=0;for(let i=v.length-p;i<v.length-1;i++){let d=v[i+1]-v[i];d>0?g+=d:l-=d}let rs=g/(l||1);return 100-100/(1+rs);}
const ATR=(h,l,c,p=14)=>EMA(h.slice(-p).map((_,i)=>Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]||0),Math.abs(l[i]-c[i-1]||0))),p);
const MACD=v=>{let a=EMA(v.slice(-26),12),b=EMA(v.slice(-26),26);return{macd:a-b,signal:EMA([a-b],9)}}

/* ================= DATA ================= */
async function fetchData(sym){
  const r=await fetch(`https://api.twelvedata.com/time_series?symbol=${sym}&interval=${INTERVAL}&outputsize=200&apikey=${TWELVE_KEY}`);
  const j=await r.json();
  return j.values.reverse();
}

/* ================= CHART ================= */
let chartLoaded=null;
function loadChart(sym){
  if(chartLoaded===sym) return;
  chartContainer.innerHTML="";
  new TradingView.widget({
    container_id:"chart",
    symbol:sym.replace("/",""),
    interval:"5",
    theme:"dark",
    width:"100%",
    height:400
  });
  chartLoaded=sym;
}

/* ================= SIGNALS ================= */
async function runSignals(){
  const sym=symbol.value;
  loadChart(sym);

  const locked=!isVIP&&!freeSymbols.includes(sym);
  if(locked){
    signals.innerHTML=`<div class="signal vip-lock"><div class="vip-badge">LOCKED</div><h3>${sym}</h3></div>`;
    return;
  }

  const d=await fetchData(sym);
  const cl=d.map(x=>+x.close),h=d.map(x=>+x.high),l=d.map(x=>+x.low);
  const macd=MACD(cl);
  const rsi=RSI(cl);
  const sig=(EMA(cl.slice(-20),10)>EMA(cl.slice(-30),20)&&macd.macd>macd.signal&&rsi>55)?"BUY":
            (EMA(cl.slice(-20),10)<EMA(cl.slice(-30),20)&&macd.macd<macd.signal&&rsi<45)?"SELL":"HOLD";

  signals.innerHTML=`
    <div class="signal">
      <div class="vip-badge">${isVIP?"VIP":"FREE"}</div>
      <h3>${sym}</h3>
      <h2 class="${sig.toLowerCase()}">${sig}</h2>
    </div>`;
}

/* ================= VIP ================= */
function startVipCountdown(exp){
  clearInterval(vipCountdownInterval);
  const t=new Date(exp).getTime();
  vipCountdownInterval=setInterval(()=>{
    const d=t-Date.now();
    if(d<=0){
      clearInterval(vipCountdownInterval);
      isVIP=false;
      vipTimerDiv.innerText="â›” VIP expired";
      runSignals();
      return;
    }
    vipTimerDiv.innerText=`VIP expires in ${Math.floor(d/86400000)}d ${Math.floor(d/3600000)%24}h ${Math.floor(d/60000)%60}m`;
  },1000);
}

function vipExpired(uid){
  set(ref(db,'users/'+uid+'/vip'),false);
  set(ref(db,'users/'+uid+'/vipExpiry'),null);
}

window.approveVip=(uid,h)=>{
  const exp=new Date(Date.now()+h*3600000).toISOString();
  set(ref(db,'users/'+uid),{vip:true,vipExpiry:exp},{merge:true});
}

/* ================= AUTH ================= */
onAuthStateChanged(auth,u=>{
  if(!u) return;
  get(child(ref(db),'users/'+u.uid)).then(s=>{
    const d=s.val()||{};
    isVIP=d.vip===true&&d.vipExpiry&&new Date(d.vipExpiry)>new Date();
    if(isVIP) startVipCountdown(d.vipExpiry);
    upgradeBtn.style.display=isVIP?'none':'inline-block';
    runSignals();
  });
});

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
registerBtn.onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value)
.then(u=>set(ref(db,'users/'+u.user.uid),{email:u.user.email,vip:false}));

upgradeBtn.onclick=()=>tidBox.style.display="flex";
activateVipBtn.onclick=()=>{
  set(ref(db,'vip_requests/'+auth.currentUser.uid),{
    tid:tidInput.value,
    status:"pending",
    requestedAt:new Date().toISOString()
  });
  alert("VIP request sent");
};

symbol.onchange=runSignals;
</script>
<script src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
