<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Signal Dashboard</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="logo_icon.png">
<link rel="shortcut icon" href="favicon.ico">

<meta name="description" content="AI Signal Dashboard for Forex, Crypto, and Commodities with EMA, RSI, and MACD indicators. Free symbols available. VIP access for premium signals.">

<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f172a; color:#e5e7eb; }
header { background:#020617; padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
select, button, input { padding:8px; border-radius:6px; border:none; }
button { background:#2563eb; color:white; cursor:pointer; }
button.secondary { background:#334155; }
#signals { padding:20px; }
.signal { background:#020617; padding:20px; border-radius:12px; max-width:420px; margin:auto; position:relative; transition: filter 0.3s ease; }
.vip-badge { position:absolute; top:10px; right:10px; background:#22c55e; color:#fff; padding:4px 8px; border-radius:8px; font-weight:bold; font-size:0.9rem; }
.buy { color:#22c55e; } 
.sell { color:#ef4444; } 
.hold { color:#9ca3af; }
.vip-lock { filter:blur(7px); pointer-events:none; }
#authBox { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-end; }
#tidBox { display:none; flex-direction:column; gap:6px; margin-top:10px; background:#1e293b; padding:12px; border-radius:10px; max-width:420px; }
#chart {
  width: 100%;
  max-width: 900px;
  height: 450px;
  margin: 20px auto;
}

#explain { background:#020617; margin:30px auto; padding:20px; max-width:900px; border-radius:12px; line-height:1.6; }
.lock { color:#fbbf24; }
.signal button { margin-top:8px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
select option.free-symbol { color: #22c55e; font-weight: bold; }
#vipTimer { margin-left:10px; font-weight:bold; color:#22c55e; }
</style>
</head>

<body>
<header>
  <div>
    <h3>üìä AI Signal Dashboard</h3>
    <select id="symbol">
      <option value="XAU/USD">XAU/USD</option>
      <option value="EUR/USD" class="free-symbol">EUR/USD (Free)</option>
      <option value="GBP/USD" class="free-symbol">GBP/USD (Free)</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="BTC/USD">BTC/USD</option>
    </select>
   
   <button id="openTVBtn" class="secondary" style="margin-left:8px;">
  üìà Full Trading History 
</button>

   
  </div>

  <div id="authBox">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn" class="secondary">Register</button>
    <button id="upgradeBtn" class="secondary" style="display:none;">Request VIP</button>

    <div id="tidBox">
      <p style="color:#fbbf24; margin:0;">
        For VIP, send 5k UGX to 0748244415 (Semakula Sharif) and enter your TID below:
      </p>
      <input id="tidInput" placeholder="TID 123456789012">
      <button id="activateVipBtn" style="background:#22c55e; color:white; cursor:pointer;">Activate VIP</button>
    </div>

    <div id="vipTimer"></div>
  </div>
</header>

<div id="chart"></div>
<div id="signals">Loading‚Ä¶</div>

<div id="explain">
  <p>AI Signal Dashboard powered by EMA, RSI, MACD indicators. Some symbols are free for everyone.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// =============== TWELVEDATA CONFIG ===============
const TWELVE_KEY = "894c1cdec16d47b98980a4423f254352";
const INTERVAL = "15min";

// =============== FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyB1G6DhAZv70YLk65ESgZl0Cm1BHzab4a0",
  authDomain: "buddydownloads-72e3b.firebaseapp.com",
  databaseURL: "https://buddydownloads-72e3b-default-rtdb.firebaseio.com",
  projectId: "buddydownloads-72e3b",
  storageBucket: "buddydownloads-72e3b.appspot.com",
  messagingSenderId: "782621240629",
  appId: "1:782621240629:web:4678fac59caad0f3ac707c"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// =============== DOM =================
const email = document.getElementById('email');
const password = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const upgradeBtn = document.getElementById('upgradeBtn');
const tidBox = document.getElementById('tidBox');
const tidInput = document.getElementById('tidInput');
const activateVipBtn = document.getElementById('activateVipBtn');
const symbol = document.getElementById('symbol');
const signals = document.getElementById('signals');
const vipTimerDiv = document.getElementById('vipTimer');

let isVIP = false;
let vipCountdownInterval = null;
const freeSymbols = ["EUR/USD", "GBP/USD"];
const cacheTime = 2 * 60 * 1000;
let cachedSignals = {};

// =============== INDICATORS =================
function EMA(v,p){let k=2/(p+1),e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
function RSI(v,p=7){let g=0,l=0;for(let i=v.length-p;i<v.length-1;i++){let d=v[i+1]-v[i];d>0?g+=d:l-=d}let rs=g/(l||1);return 100-100/(1+rs);}
function ATR(h,l,c,p=14){let t=[];for(let i=1;i<c.length;i++)t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));return EMA(t.slice(-p),p);}
function MACD(v){let a=EMA(v.slice(-26),12),b=EMA(v.slice(-26),26);return{macd:a-b,signal:EMA([a-b],9)};}

// =============== SIGNAL LOGIC =================
// Step 1: Technical signal per candle
function technical_signal({ema10, ema20, rsi, macd, macdSignal}) {
    let s = 0;
    ema10 > ema20 ? s += 30 : s -= 30;
    rsi > 55 ? s += 20 : rsi < 45 ? s -= 20 : null;
    macd > macdSignal ? s += 20 : s -= 20;
    if (s >= 35) return { signal: "BUY", strength: s };
    if (s <= -35) return { signal: "SELL", strength: Math.abs(s) };
    return { signal: "HOLD", strength: Math.abs(s) };
}

// Step 2: Final signal logic (could include higher timeframe or S/R filters)
function final_signal_logic(techSignal, higherSignal = null) {
    // simple example: if higher timeframe conflicts, hold
    if (higherSignal && higherSignal.signal !== techSignal.signal) return { signal: "HOLD", strength: techSignal.strength };
    return techSignal;
}

// Step 3: Calculate SL/TP
function calculate_sl_tp(entry, atr, signal) {
    let r = atr * 1.2, t = r * 1.5;
    if (signal === "BUY") return { sl: entry - r, tp: entry + t };
    if (signal === "SELL") return { sl: entry + r, tp: entry - t };
    return { sl: entry, tp: entry };
}

// Step 4: Lot size based on fixed risk (example: risk 1% per trade)
function calculate_lot_size_from_risk(balance = 1000, riskPercent = 1, entry, sl) {
    const risk = balance * (riskPercent / 100);
    const pipDistance = Math.abs(entry - sl);
    if (pipDistance === 0) return 0.01; // minimum lot
    return parseFloat((risk / pipDistance).toFixed(2));
}

// =============== FETCH MARKET DATA =================
async function fetchData(symbol){
    let url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${INTERVAL}&outputsize=200&apikey=${TWELVE_KEY}`;
    let r = await fetch(url);
    let j = await r.json();
    return j.values.reverse();
}

// =============== DISPLAY SIGNAL =================
function displaySignals({symbolVal, sig, entry, sltp, lot}) {
    const isFree = freeSymbols.includes(symbolVal);
    let vipBadgeHtml = "";
    let blurClass = "";

    if (isVIP) {
        vipBadgeHtml = `<div class="vip-badge">VIP Active</div>`;
    } else if (isFree) {
        vipBadgeHtml = `<div class="vip-badge" style="background:#22c55e">FREE</div>`;
    } else {
        blurClass = "vip-lock";
    }

    signals.innerHTML = `
        <div class="signal ${blurClass}">
            ${vipBadgeHtml}
            <h3>${symbolVal}</h3>
            <h2 class="${sig.signal.toLowerCase()}">${sig.signal}</h2>
            <p>Entry: ${entry.toFixed(2)}</p>
            <p>SL: ${sltp.sl.toFixed(2)}</p>
            <p>TP: ${sltp.tp.toFixed(2)}</p>
            <p>Lot: ${lot}</p>
            <p>Strength: ${sig.strength}%</p>
            ${(isVIP||isFree) ? `<p>Signal: ${symbolVal} ${sig.signal}</p>` : ""}
        </div>
        ${(isVIP||isFree) ? "" : "<p style='text-align:center'>üîí Request VIP to unlock signals</p>"}
    `;
}

// =============== RUN SIGNALS =================
async function runSignals(){
    const symbolVal = symbol.value;

    const now = Date.now();
    if(cachedSignals[symbolVal] && now - cachedSignals[symbolVal].time < cacheTime){
        displaySignals(cachedSignals[symbolVal].data);
        return;
    }

    try {
        let data = await fetchData(symbolVal);
        let cl = data.map(x=>+x.close), h=data.map(x=>+x.high), l=data.map(x=>+x.low);

        const techSignal = technical_signal({
            ema10: EMA(cl.slice(-20),10),
            ema20: EMA(cl.slice(-30),20),
            rsi: RSI(cl),
            macd: MACD(cl).macd,
            macdSignal: MACD(cl).signal
        });

        const finalSignal = final_signal_logic(techSignal);

        const entry = cl.at(-1);
        const sltp = calculate_sl_tp(entry, ATR(h,l,cl), finalSignal.signal);
        const lot = calculate_lot_size_from_risk(1000,1,entry,sltp.sl);

        const signalData = { symbolVal, sig: finalSignal, entry, sltp, lot };
        cachedSignals[symbolVal] = { data: signalData, time: now };

        displaySignals(signalData);

        // Optional: save to Firebase
        if(finalSignal.signal === "BUY" || finalSignal.signal === "SELL"){
            const signalsRefDb = ref(db,'signals');
            const snapshot = await get(signalsRefDb);
            const existing = snapshot.val() || {};
            const duplicate = Object.values(existing).some(s => s.symbol===symbolVal && s.type===finalSignal.signal);
            if(!duplicate){
                await set(ref(db,'signals/'+Date.now()), {
                    symbol: symbolVal,
                    type: finalSignal.signal,
                    entry,
                    sl: sltp.sl,
                    tp: sltp.tp,
                    lot,
                    time: Date.now()
                });
            }
        }

    } catch(e){
        signals.innerHTML = "<p style='color:#fbbf24;text-align:center;'>‚ùå Error fetching data from Twelvedata. Check API key or symbol.</p>";
    }
}

// =============== AUTH & VIP HANDLING =================
loginBtn.onclick = ()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
registerBtn.onclick = ()=>createUserWithEmailAndPassword(auth,email.value,password.value)
    .then(uc=>{ set(ref(db,'users/'+uc.user.uid),{email:uc.user.email,vip:false,created:new Date().toISOString()}); alert("Account created. Request VIP from the button."); })
    .catch(e=>alert(e.message));

onAuthStateChanged(auth, user => {
    clearInterval(vipCountdownInterval);
    vipTimerDiv.innerText = "";
    isVIP = false;

    if (!user) { upgradeBtn.style.display = 'inline-block'; runSignals(); return; }

    const userRef = ref(db,'users/'+user.uid);
    get(userRef).then(snap=>{
        const data = snap.val()||{};
        if(data.vip && data.vipExpiry && new Date(data.vipExpiry).getTime()>Date.now()){
            isVIP = true;
            startVipCountdown(data.vipExpiry);
        } else if(data.vip) vipExpired(user.uid);

        upgradeBtn.style.display = isVIP?'none':'inline-block';
        return get(child(ref(db),'vip_requests/'+user.uid));
    }).then(r=>{
        if(r.exists() && r.val().status==='pending') upgradeBtn.style.display='none';
        runSignals();
    }).catch(err=>console.error(err));
});

upgradeBtn.onclick=()=>{ const user=auth.currentUser; if(!user)return alert("Please login first."); tidBox.style.display="flex"; upgradeBtn.style.display="none"; };
activateVipBtn.onclick=()=>{ 
    const tidValue=tidInput.value.trim();
    if(!/^TID\s\d{12}$/.test(tidValue)){alert("‚ùå Invalid TID format");return;}
    const user=auth.currentUser; if(!user)return alert("Please login first.");
    set(ref(db,'vip_requests/'+user.uid),{email:user.email,requestedAt:new Date().toISOString(),tid:tidValue,status:"pending"})
    .then(()=>{alert("‚úÖ VIP request sent!"); activateVipBtn.disabled=true; activateVipBtn.innerText="TID Submitted";})
    .catch(err=>alert(err.message));
};

symbol.addEventListener('change',runSignals);
setInterval(runSignals,20*60*1000);
</script>

<script src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
