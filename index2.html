<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Signal Dashboard</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="logo_icon.png">
<link rel="shortcut icon" href="favicon.ico">

<meta name="description" content="AI Signal Dashboard for Forex, Crypto, and Commodities with EMA, RSI, and MACD indicators. Free symbols available. VIP access for premium signals.">

<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f172a; color:#e5e7eb; }
header { background:#020617; padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
select, button, input { padding:8px; border-radius:6px; border:none; }
button { background:#2563eb; color:white; cursor:pointer; }
button.secondary { background:#334155; }
#signals { padding:20px; }
.signal { background:#020617; padding:20px; border-radius:12px; max-width:420px; margin:auto; position:relative; transition: filter 0.3s ease; }
.vip-badge { position:absolute; top:10px; right:10px; background:#22c55e; color:#fff; padding:4px 8px; border-radius:8px; font-weight:bold; font-size:0.9rem; }
.buy { color:#22c55e; } 
.sell { color:#ef4444; } 
.hold { color:#9ca3af; }
.vip-lock { filter:blur(7px); pointer-events:none; }
#authBox { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-end; }
#tidBox { display:none; flex-direction:column; gap:6px; margin-top:10px; background:#1e293b; padding:12px; border-radius:10px; max-width:420px; }
#chart {
  width: 100%;
  max-width: 900px;
  height: 450px;
  margin: 20px auto;
}

#explain { background:#020617; margin:30px auto; padding:20px; max-width:900px; border-radius:12px; line-height:1.6; }
.lock { color:#fbbf24; }
.signal button { margin-top:8px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
select option.free-symbol { color: #22c55e; font-weight: bold; }
#vipTimer { margin-left:10px; font-weight:bold; color:#22c55e; }
</style>
</head>

<body>
<header>
  <div>
    <h3>üìä AI Signal Dashboard</h3>
    <select id="symbol">
      <option value="XAU/USD">XAU/USD</option>
      <option value="EUR/USD" class="free-symbol">EUR/USD (Free)</option>
      <option value="GBP/USD" class="free-symbol">GBP/USD (Free)</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="BTC/USD">BTC/USD</option>
    </select>
   
   <button id="openTVBtn" class="secondary" style="margin-left:8px;">
  üìà Full Trading History 
</button>

   
  </div>

  <div id="authBox">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn" class="secondary">Register</button>
    <button id="upgradeBtn" class="secondary" style="display:none;">Request VIP</button>

    <div id="tidBox">
      <p style="color:#fbbf24; margin:0;">
        For VIP, send 5k UGX to 0748244415 (Semakula Sharif) and enter your TID below:
      </p>
      <input id="tidInput" placeholder="TID 123456789012">
      <button id="activateVipBtn" style="background:#22c55e; color:white; cursor:pointer;">Activate VIP</button>
    </div>

    <div id="vipTimer"></div>
  </div>
</header>

<div id="chart"></div>
<div id="signals">Loading‚Ä¶</div>

<div id="explain">
  <p>AI Signal Dashboard powered by EMA, RSI, MACD indicators. Some symbols are free for everyone.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// =============== TWELVEDATA CONFIG ===============
const TWELVE_KEY = "894c1cdec16d47b98980a4423f254352";
const INTERVAL = "15min";

// =============== FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyB1G6DhAZv70YLk65ESgZl0Cm1BHzab4a0",
  authDomain: "buddydownloads-72e3b.firebaseapp.com",
  databaseURL: "https://buddydownloads-72e3b-default-rtdb.firebaseio.com",
  projectId: "buddydownloads-72e3b",
  storageBucket: "buddydownloads-72e3b.appspot.com",
  messagingSenderId: "782621240629",
  appId: "1:782621240629:web:4678fac59caad0f3ac707c"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// =============== DOM =================
const email = document.getElementById('email');
const password = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const upgradeBtn = document.getElementById('upgradeBtn');
const tidBox = document.getElementById('tidBox');
const tidInput = document.getElementById('tidInput');
const activateVipBtn = document.getElementById('activateVipBtn');
const symbol = document.getElementById('symbol');
const signals = document.getElementById('signals');
const chartContainer = document.getElementById('chart');
const vipTimerDiv = document.getElementById('vipTimer');

let isVIP = false;
let vipCountdownInterval = null;
const freeSymbols = ["EUR/USD", "GBP/USD"];

let chartLoaded = null;          // track current chart symbol
let cachedSignals = {};          // store cached signals per symbol
const cacheTime = 2 * 60 * 1000; // 2 minutes cache


// =============== INDICATORS =================
function EMA(v,p){let k=2/(p+1),e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
function RSI(v,p=7){let g=0,l=0;for(let i=v.length-p;i<v.length-1;i++){let d=v[i+1]-v[i];d>0?g+=d:l-=d}let rs=g/(l||1);return 100-100/(1+rs);}
function ATR(h,l,c,p=14){let t=[];for(let i=1;i<c.length;i++)t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));return EMA(t.slice(-p),p);}
function MACD(values){
  const macdLine = values.map((_, i) => {
    if (i < 26) return null;
    return EMA(values.slice(i-12, i),12) - EMA(values.slice(i-26, i),26);
  }).filter(Boolean);

  return {
    macd: macdLine.at(-1),
    signal: EMA(macdLine.slice(-9), 9)
  };
}

function generateSignal(d, weights){
  let score = 0;

  // EMA trend
  score += d.ema10 > d.ema20 ? weights.ema : -weights.ema;

  // RSI bias
  if(d.rsi > 55) score += weights.rsi;
  else if(d.rsi < 45) score -= weights.rsi;

  // MACD momentum
  score += d.macd > d.macdSignal ? weights.macd : -weights.macd;

  // SR proximity
  if(d.nearSupport) score += weights.sr;
  if(d.nearResistance) score -= weights.sr;

  let signal = "HOLD";
  if(score >= 40) signal = "BUY";
  if(score <= -40) signal = "SELL";

  return {
    signal,
    strength: Math.min(100, Math.abs(score))
  };
}
function SLTP(e,a,s){let r=a*1.2,t=r*1.5;if(s==="BUY")return{sl:e-r,tp:e+t};if(s==="SELL")return{sl:e+r,tp:e-t};return{sl:e,tp:e};}

function marketProfile(symbol){
  if(symbol.includes("XAU")) return { ema:40, rsi:20, macd:25, sr:15 };
  if(symbol.includes("BTC")) return { ema:30, rsi:15, macd:35, sr:20 };
  return { ema:35, rsi:25, macd:25, sr:15 }; // FX default
}


// =============== FETCH MARKET DATA =================
async function fetchData(symbol){
  let url=`https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${INTERVAL}&outputsize=200&apikey=${TWELVE_KEY}`;
  let r = await fetch(url);
  let j = await r.json();
  return j.values.reverse();
}

async function fetchHTF(symbol){
  const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=15m&outputsize=120&apikey=${TWELVE_KEY}`;
  const r = await fetch(url);
  const j = await r.json();

  if(!j.values) {
    console.warn("HTF fetch failed:", j);
    return []; // fallback empty array
  }

  return j.values.reverse();
}


function htfTrend(cl){
  const ema50 = EMA(cl.slice(-60), 50);
  return cl.at(-1) > ema50 ? "BULL" : "BEAR";
}


// ================= CHART =================
let chartWidget = null; // store widget instance for plotting
let chartSymbolsHistory = {}; // keep history per symbol

function loadChart(symbolVal){
  if(chartLoaded === symbolVal) return;
  chartContainer.innerHTML = "";

 chartWidget = new TradingView.widget({
  container_id:"chart",
  symbol:symbolVal.replace("/",""),
  interval:"5",
  theme:"dark",
  autosize:true,  // keep this
  studies: []
});


  chartLoaded = symbolVal;

  // initialize history if doesn't exist
  if(!chartSymbolsHistory[symbolVal]) chartSymbolsHistory[symbolVal] = [];
}



async function sendSignalIfNotExists(signalData) {
  const { symbolVal, sig, entry, sltp, candleTime } = signalData;

  if (sig.signal !== "BUY" && sig.signal !== "SELL") return;

  const signalsRefDb = ref(db, 'signals');

  try {
    // Fetch existing signals
    const snapshot = await get(signalsRefDb);
    const existing = snapshot.val() || {};

    // Check if a signal for the same symbol + type + candleTime exists
    const duplicate = Object.values(existing).some(s => 
      s.symbol === symbolVal &&
      s.type === sig.signal &&
      s.time === candleTime
    );

    if (duplicate) {
      console.log("Signal already exists in Firebase. Skipping:", sig.signal, symbolVal);
      return; // don‚Äôt send again
    }

    // If not duplicate, push new signal
    const now = Date.now();
    const newRef = ref(db, 'signals/' + now);

    await set(newRef, {
      symbol: symbolVal,
      type: sig.signal,
      price: entry,
      sl: sltp.sl,
      tp: sltp.tp,
      result: null,
      time: candleTime,
      sentTime: now
    });

    console.log("Signal sent to Firebase:", sig.signal, symbolVal);

  } catch(err) {
    console.error("Error checking/sending signal:", err);
  }
}

function getSR(closes, lookback = 50){
  const recent = closes.slice(-lookback);
  return {
    support: Math.min(...recent),
    resistance: Math.max(...recent)
  };
}

function lastCandleConfirm(data, direction){
  const last = data.at(-1);
  const open = +last.open;
  const close = +last.close;

  if(direction === "BUY") return close > open;
  if(direction === "SELL") return close < open;
  return false;
}

function backtest(data, signal){
  let wins = 0, losses = 0;
  for(let i = 30; i < data.length - 5; i++){
    const entry = +data[i].close;
    const future = +data[i+5].close;

    if(signal === "BUY" && future > entry) wins++;
    else if(signal === "SELL" && future < entry) wins++;
    else losses++;
  }
  const total = wins + losses || 1;
  return Math.round((wins / total) * 100);
}


// ================= SIGNALS =================
async function runSignals() {
  const symbolVal = symbol.value;
  loadChart(symbolVal);

  const now = Date.now();

  // Use cached signals if still valid
  if (cachedSignals[symbolVal] && now - cachedSignals[symbolVal].time < cacheTime) {
    displaySignals(cachedSignals[symbolVal].data);
    plotSignalOnChart({ ...cachedSignals[symbolVal].data, symbolVal });
    return;
  }

  try {
    // ================= FETCH LTF DATA =================
    const data = await fetchData(symbolVal);
    if (!data || !data.length) throw new Error("No LTF data returned");

    const cl = data.map(x => +x.close);
    const h  = data.map(x => +x.high);
    const l  = data.map(x => +x.low);
    const entry = cl.at(-1);

    // ================= WEIGHTS (MARKET PROFILE) =================
    const weights = marketProfile(symbolVal);

    // ================= SUPPORT & RESISTANCE =================
    const sr = getSR(cl);
    const nearResistance = entry > sr.resistance * 0.995;
    const nearSupport    = entry < sr.support * 1.005;

    // ================= HTF TREND =================
    let trend = "RANGE"; // default
    try {
      const htfData = await fetchHTF(symbolVal);
      if (htfData && htfData.length) {
        const htfClose = htfData.map(x => +x.close);
        trend = htfTrend(htfClose);
      } else {
        console.warn(`HTF fetch failed or empty for ${symbolVal}, using LTF fallback`);
        trend = htfTrend(cl.slice(-60)); // fallback to LTF
      }
    } catch (htfErr) {
      console.warn(`Error fetching HTF for ${symbolVal}:`, htfErr);
      trend = htfTrend(cl.slice(-60)); // fallback to LTF
    }

    // ================= SIGNAL GENERATION =================
    let sig = generateSignal({
      ema10: EMA(cl.slice(-20), 10),
      ema20: EMA(cl.slice(-30), 20),
      rsi: RSI(cl),
      macd: MACD(cl).macd,
      macdSignal: MACD(cl).signal,
      nearSupport,
      nearResistance
    }, weights);

    // ================= HTF ALIGNMENT FILTER =================
    if (sig.signal === "BUY" && trend !== "BULL") sig.signal = "HOLD";
    if (sig.signal === "SELL" && trend !== "BEAR") sig.signal = "HOLD";

    // ================= LAST CANDLE CONFIRMATION =================
    if (sig.signal !== "HOLD" && !lastCandleConfirm(data, sig.signal)) {
      sig.signal = "HOLD";
    }

    // ================= SL / TP =================
    let sltp = null;
    if (sig.signal !== "HOLD") {
      sltp = SLTP(entry, ATR(h, l, cl), sig.signal);
    }

    // VIP check
    if (!isVIP && !freeSymbols.includes(symbolVal)) {
      signals.innerHTML = "üîí VIP required";
      return;
    }

    // ================= FINAL PACKAGE =================
    const lastCandleTime = new Date(data.at(-1).datetime).getTime();
    const signalData = {
      symbolVal,
      sig,
      entry,
      sltp,
      candleTime: lastCandleTime,
      sr,
      nearSupport,
      nearResistance,
      trend
    };

    cachedSignals[symbolVal] = { data: signalData, time: now };

    displaySignals(signalData);
    plotSignalOnChart(signalData);

    if (sig.signal !== "HOLD") {
      sendSignalIfNotExists(signalData);
    }

  } catch (err) {
    console.error("runSignals error:", err);
    signals.innerHTML = `
      <p style="color:#fbbf24; text-align:center;">
        ‚ùå Error fetching data from Twelvedata. Check API key, symbol, or API limits.
      </p>`;
  }
}



// ================= DISPLAY SIGNALS =================
function displaySignals({ symbolVal, sig, entry, sltp, trend, backtestScore }) {
  const isFree = freeSymbols.includes(symbolVal);
  let vipBadgeHtml = "";
  let blurClass = "";

  if (isVIP) {
    vipBadgeHtml = `<div class="vip-badge">VIP Active</div>`;
  } else if (isFree) {
    vipBadgeHtml = `<div class="vip-badge" style="background:#22c55e">FREE</div>`;
  } else {
    blurClass = "vip-lock";
  }

  signals.innerHTML = `
    <div class="signal ${blurClass}">
      ${vipBadgeHtml}
      <h3>${symbolVal}</h3>
      <h2 class="${sig.signal.toLowerCase()}">${sig.signal}</h2>

      <p>Entry: ${entry.toFixed(2)} 
        <span class="copy-link" data-copy="${entry.toFixed(2)}">üîó</span>
      </p>
      <p>SL: ${sltp?.sl?.toFixed(2) ?? "-"} 
        <span class="copy-link" data-copy="${sltp?.sl?.toFixed(2) ?? "-"}">üîó</span>
      </p>
      <p>TP: ${sltp?.tp?.toFixed(2) ?? "-"} 
        <span class="copy-link" data-copy="${sltp?.tp?.toFixed(2) ?? "-"}">üîó</span>
      </p>

      <p>Strength: ${sig.strength}%</p>
      <p>HTF Trend: ${trend}</p>
      ${backtestScore !== null ? `<p>Backtest Win Rate: ${backtestScore}%</p>` : ""}

      ${(isVIP || isFree) 
        ? `<p><span class="copy-link" data-copy="${symbolVal} ${sig.signal}">üîó Copy Signal</span></p>` 
        : "<p style='text-align:center'>üîí Request VIP to unlock signals</p>"}
    </div>
  `;

  // Ensure style added only once
  if (!document.getElementById('copy-link-style')) {
    const style = document.createElement('style');
    style.id = 'copy-link-style';
    style.innerHTML = `.copy-link{cursor:pointer; color:#2563eb; margin-left:5px; text-decoration:underline;}`;
    document.head.appendChild(style);
  }

  // Attach copy click events
  const copyLinks = signals.querySelectorAll('.copy-link');
  copyLinks.forEach(el => {
    el.onclick = () => copySignal(el.getAttribute('data-copy'));
  });
}

// ================= COPY SIGNAL =================
function copySignal(text) {
  if (!text) return;
  navigator.clipboard.writeText(text)
    .then(() => alert(`‚úÖ Copied: ${text}`))
    .catch(err => alert("‚ùå Copy failed: " + err));
}

// ================= VIP COUNTDOWN =================
function startVipCountdown(expiryIso) {
  clearInterval(vipCountdownInterval); // reset previous interval
  const expiryTime = new Date(expiryIso).getTime();

  vipCountdownInterval = setInterval(() => {
    const diff = expiryTime - Date.now();

    if (diff <= 0) {
      clearInterval(vipCountdownInterval);
      isVIP = false;

      if (auth.currentUser) {
        vipExpired(auth.currentUser.uid);
      }

      vipTimerDiv.innerText = "‚õî VIP expired";
      alert("‚è≥ Your VIP subscription has expired.");

      // Force page refresh after short delay
      setTimeout(() => location.reload(), 1000);
      return;
    }

    const d = Math.floor(diff / 86400000);
    const h = Math.floor((diff % 86400000) / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);

    vipTimerDiv.innerText = `VIP expires in ${d}d ${h}h ${m}m ${s}s`;
  }, 1000);
}

function vipExpired(uid) {
  const userRef = ref(db, 'users/' + uid);
  get(userRef).then(snap => {
    const data = snap.val() || {};
    const key = data.vipKey;

    if (key) {
      set(ref(db, 'vip_keys/' + key + '/active'), false);
    }

    // Clear VIP info for this user
    set(ref(db, 'users/' + uid + '/vip'), false);
    set(ref(db, 'users/' + uid + '/vipKey'), null);
    set(ref(db, 'users/' + uid + '/vipExpiry'), null);
  });
}



// =============== AUTH =================
loginBtn.onclick = ()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
registerBtn.onclick = ()=>createUserWithEmailAndPassword(auth,email.value,password.value)
.then(uc=>{
  set(ref(db,'users/'+uc.user.uid),{email:uc.user.email,vip:false,created:new Date().toISOString()});
  alert("Account created. Request VIP from the button.");
})
.catch(e=>alert(e.message));

onAuthStateChanged(auth, user => {
  clearInterval(vipCountdownInterval); // clear old VIP countdown
  vipTimerDiv.innerText = "";          // reset timer
  isVIP = false;

  if (!user) {
    // No user logged in, reset UI
    upgradeBtn.style.display = 'inline-block';
    runSignals(); // show free signals only
    return;
  }

  const userRef = ref(db, 'users/' + user.uid);

  // Fetch current user's VIP info
  get(userRef).then(snap => {
    const data = snap.val() || {};

    // Check VIP status
    if (data.vip === true && data.vipExpiry) {
      const expiryTime = new Date(data.vipExpiry).getTime();

      if (expiryTime > Date.now()) {
        isVIP = true;
        startVipCountdown(data.vipExpiry); // start countdown for this user
      } else {
        // VIP expired
        vipExpired(user.uid);
      }
    }

    // Show/hide VIP request button
    upgradeBtn.style.display = isVIP ? 'none' : 'inline-block';

    // Check if user already has a pending VIP request
    return get(child(ref(db), 'vip_requests/' + user.uid));
  }).then(r => {
    if (r.exists() && r.val().status === "pending") {
      upgradeBtn.style.display = "none"; // hide button if request pending
    }

    // Run signals after VIP check
    runSignals();
  }).catch(err => {
    console.error("Auth/VIP check error:", err);
  });
});




upgradeBtn.onclick=()=>{
  const user=auth.currentUser;
  if(!user) return alert("Please login first.");
  tidBox.style.display="flex";
  upgradeBtn.style.display="none";
};

activateVipBtn.onclick=()=>{
  const tidValue=tidInput.value.trim();
  const tidPattern=/^TID\s\d{12}$/;
  if(!tidPattern.test(tidValue)){alert("‚ùå Invalid TID format. Use: TID 123456789012");return;}
  const user=auth.currentUser;if(!user)return alert("Please login first.");
  set(ref(db,'vip_requests/'+user.uid),{email:user.email,requestedAt:new Date().toISOString(),tid:tidValue,status:"pending"})
  .then(()=>{alert("‚úÖ VIP request sent! Admin will verify payment.");activateVipBtn.disabled=true;activateVipBtn.innerText="TID Submitted";})
  .catch(err=>alert(err.message));
};

symbol.addEventListener('change',runSignals);
setInterval(runSignals,20*60*1000);

const openTVBtn = document.getElementById("openTVBtn");

openTVBtn.onclick = () => {
  const symbolVal = symbol.value.replace("/", "");
  window.open(
    `TRADINGVIEW.html?symbol=${symbolVal}`, // URL to open
    "_blank"                                // open in a new tab
  );
};

</script>
<script src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
