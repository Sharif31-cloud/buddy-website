<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Signal Dashboard</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="logo_icon.png">
<link rel="shortcut icon" href="favicon.ico">

<meta name="description" content="AI Signal Dashboard for Forex, Crypto, and Commodities with EMA, RSI, and MACD indicators. Free symbols available. VIP access for premium signals.">

<style>
body { margin:0; font-family:Arial,sans-serif; background:#0f172a; color:#e5e7eb; }
header { background:#020617; padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
select, button, input { padding:8px; border-radius:6px; border:none; }
button { background:#2563eb; color:white; cursor:pointer; }
button.secondary { background:#334155; }
#signals { padding:20px; }
.signal { background:#020617; padding:20px; border-radius:12px; max-width:420px; margin:auto; position:relative; transition: filter 0.3s ease; }
.vip-badge { position:absolute; top:10px; right:10px; background:#22c55e; color:#fff; padding:4px 8px; border-radius:8px; font-weight:bold; font-size:0.9rem; }
.buy { color:#22c55e; } 
.sell { color:#ef4444; } 
.hold { color:#9ca3af; }
.vip-lock { filter:blur(7px); pointer-events:none; }
#authBox { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-end; }
#tidBox { display:none; flex-direction:column; gap:6px; margin-top:10px; background:#1e293b; padding:12px; border-radius:10px; max-width:420px; }
#chart { margin:20px auto; max-width:900px; }
#explain { background:#020617; margin:30px auto; padding:20px; max-width:900px; border-radius:12px; line-height:1.6; }
.lock { color:#fbbf24; }
.signal button { margin-top:8px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2563eb; color:white; }
select option.free-symbol { color: #22c55e; font-weight: bold; }
#vipTimer { margin-left:10px; font-weight:bold; color:#22c55e; }
</style>
</head>

<body>
<header>
  <div>
    <h3>üìä AI Signal Dashboard</h3>
    <select id="symbol">
      <option value="XAU/USD">XAU/USD</option>
      <option value="EUR/USD" class="free-symbol">EUR/USD (Free)</option>
      <option value="GBP/USD" class="free-symbol">GBP/USD (Free)</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="BTC/USD">BTC/USD</option>
    </select>
  </div>

  <div id="authBox">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn" class="secondary">Register</button>
    <button id="upgradeBtn" class="secondary" style="display:none;">Request VIP</button>

    <div id="tidBox">
      <p style="color:#fbbf24; margin:0;">
        For VIP, send 5k UGX to 0748244415 (Semakula Sharif) and enter your TID below:
      </p>
      <input id="tidInput" placeholder="TID 123456789012">
      <button id="activateVipBtn" style="background:#22c55e; color:white; cursor:pointer;">Activate VIP</button>
    </div>

    <div id="vipTimer"></div>
  </div>
</header>

<div id="chart"></div>
<div id="signals">Loading‚Ä¶</div>

<div id="explain">
  <p>AI Signal Dashboard powered by EMA, RSI, MACD indicators. Some symbols are free for everyone.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= CONFIG ================= */
const TWELVE_KEY = "894c1cdec16d47b98980a4423f254352";
const INTERVAL = "5min";
const freeSymbols = ["EUR/USD", "GBP/USD"];

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey: "AIzaSyB1G6DhAZv70YLk65ESgZl0Cm1BHzab4a0",
  authDomain: "buddydownloads-72e3b.firebaseapp.com",
  databaseURL: "https://buddydownloads-72e3b-default-rtdb.firebaseio.com",
  projectId: "buddydownloads-72e3b"
});
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= DOM ================= */
const email = document.getElementById("email");
const password = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const upgradeBtn = document.getElementById("upgradeBtn");
const tidBox = document.getElementById("tidBox");
const tidInput = document.getElementById("tidInput");
const activateVipBtn = document.getElementById("activateVipBtn");
const symbol = document.getElementById("symbol");
const signals = document.getElementById("signals");
const chartContainer = document.getElementById("chart");
const vipTimerDiv = document.getElementById("vipTimer");

/* ================= STATE ================= */
let isVIP = false;
let vipExpiryTime = null;
let vipInterval = null;
let chartLoaded = null;
let cachedSignals = {};
const cacheTime = 5 * 60 * 1000;

/* ================= INDICATORS ================= */
function EMA(v,p){let k=2/(p+1),e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
function RSI(v,p=7){let g=0,l=0;for(let i=v.length-p;i<v.length-1;i++){let d=v[i+1]-v[i];d>0?g+=d:l-=d}let rs=g/(l||1);return 100-100/(1+rs);}
function ATR(h,l,c,p=14){let t=[];for(let i=1;i<c.length;i++)t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));return EMA(t.slice(-p),p);}
function MACD(v){let a=EMA(v.slice(-26),12),b=EMA(v.slice(-26),26);return{macd:a-b,signal:EMA([a-b],9)};}

function generateSignal(d){
  let s=0;
  d.ema10>d.ema20?s+=30:s-=30;
  d.rsi>55?s+=20:d.rsi<45?s-=20:null;
  d.macd>d.macdSignal?s+=20:s-=20;
  if(s>=35)return{signal:"BUY",strength:s};
  if(s<=-35)return{signal:"SELL",strength:Math.abs(s)};
  return{signal:"HOLD",strength:Math.abs(s)};
}

/* ================= DATA ================= */
async function fetchData(sym){
  const r = await fetch(`https://api.twelvedata.com/time_series?symbol=${sym}&interval=${INTERVAL}&outputsize=200&apikey=${TWELVE_KEY}`);
  const j = await r.json();
  return j.values.reverse();
}

/* ================= CHART ================= */
function loadChart(sym){
  if(chartLoaded===sym) return;
  chartContainer.innerHTML="";
  new TradingView.widget({
    container_id:"chart",
    symbol:sym.replace("/",""),
    interval:"5",
    theme:"dark",
    width:"100%",
    height:400
  });
  chartLoaded = sym;
}

/* ================= SIGNALS ================= */
async function runSignals(force=false){
  const sym = symbol.value;
  loadChart(sym);

  const now = Date.now();
  if(!force && cachedSignals[sym] && now-cachedSignals[sym].time<cacheTime){
    renderSignal(cachedSignals[sym].data);
    return;
  }

  try{
    const data = await fetchData(sym);
    const cl=data.map(x=>+x.close), h=data.map(x=>+x.high), l=data.map(x=>+x.low);
    const sig=generateSignal({
      ema10:EMA(cl.slice(-20),10),
      ema20:EMA(cl.slice(-30),20),
      rsi:RSI(cl),
      macd:MACD(cl).macd,
      macdSignal:MACD(cl).signal
    });

    const entry=cl.at(-1);
    const atr=ATR(h,l,cl);
    const sl=sig.signal==="BUY"?entry-atr*1.2:entry+atr*1.2;
    const tp=sig.signal==="BUY"?entry+atr*1.8:entry-atr*1.8;

    const payload={sym,sig,entry,sl,tp};
    cachedSignals[sym]={data:payload,time:now};
    renderSignal(payload);
  }catch{
    signals.innerHTML="‚ùå Error loading data";
  }
}

function renderSignal(d){
  const isFree=freeSymbols.includes(d.sym);
  const locked=!isVIP&&!isFree;

  signals.innerHTML=`
  <div class="signal ${locked?'vip-lock':''}">
    ${isVIP?'<div class="vip-badge">VIP</div>':isFree?'<div class="vip-badge">FREE</div>':''}
    <h3>${d.sym}</h3>
    <h2 class="${d.sig.signal.toLowerCase()}">${d.sig.signal}</h2>
    <p>Entry: ${d.entry.toFixed(2)}</p>
    <p>SL: ${d.sl.toFixed(2)}</p>
    <p>TP: ${d.tp.toFixed(2)}</p>
    ${(isVIP||isFree)?'<button onclick="copySignal()">Copy Signal</button>':''}
  </div>
  ${locked?'<p style="text-align:center">üîí Request VIP</p>':''}`;
}

window.copySignal=()=>navigator.clipboard.writeText("Signal copied");

/* ================= VIP TIMER ================= */
function startVipCountdown(){
  clearInterval(vipInterval);
  vipInterval=setInterval(()=>{
    const diff=vipExpiryTime-Date.now();
    if(diff<=0){
      clearInterval(vipInterval);
      isVIP=false;
      vipTimerDiv.innerText="VIP expired ‚è≥";
      upgradeBtn.style.display="inline-block";
      runSignals(true);
      return;
    }
    const d=Math.floor(diff/86400000);
    const h=Math.floor(diff%86400000/3600000);
    const m=Math.floor(diff%3600000/60000);
    vipTimerDiv.innerText=`VIP expires in ${d}d ${h}h ${m}m`;
  },1000);
}

/* ================= AUTH ================= */
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
registerBtn.onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value)
.then(u=>set(ref(db,"users/"+u.user.uid),{email:u.user.email,vip:false}));

onAuthStateChanged(auth,user=>{
  if(!user) return;
  get(child(ref(db),"users/"+user.uid)).then(s=>{
    const d=s.val()||{};
    isVIP=d.vip===true;
    upgradeBtn.style.display=isVIP?'none':'inline-block';
    if(isVIP&&d.vipExpiry){
      vipExpiryTime=new Date(d.vipExpiry).getTime();
      startVipCountdown();
    } else vipTimerDiv.innerText="";
    runSignals(true);
  });
});

upgradeBtn.onclick=()=>tidBox.style.display="flex";
activateVipBtn.onclick=()=>{
  const u=auth.currentUser;
  set(ref(db,"vip_requests/"+u.uid),{
    email:u.email,
    tid:tidInput.value,
    requestedAt:new Date().toISOString(),
    status:"pending"
  }).then(()=>alert("VIP request sent"));
};

symbol.onchange=()=>runSignals(true);
setInterval(runSignals,cacheTime);
</script>

<script src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
