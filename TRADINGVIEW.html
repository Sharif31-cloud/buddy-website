<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Signal Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="icon" type="image/png" href="logo_icon.png">
<link rel="shortcut icon" href="logo_icon.png">
<link rel="apple-touch-icon" href="logo_icon.png">

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:Arial, sans-serif;
}

#topBar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  background:#020617;
  border-bottom:1px solid #1e293b;
}

#stats{
  margin-left:auto;
  font-size:13px;
  color:#94a3b8;
}

select, button{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  font-size:13px;
}

button{
  background:#ef4444;
  color:white;
  cursor:pointer;
}

#signalsContainer{
  padding:10px;
  max-height:calc(100vh - 50px);
  overflow-y:auto;
}

.signalCard{
  border-radius:6px;
  padding:10px;
  margin-bottom:8px;
  background:#1e293b;
}

.buy{ background:#16a34a; }
.sell{ background:#dc2626; }

.win{ border-left:4px solid #22c55e; }
.loss{ border-left:4px solid #ef4444; }
.unknown{ border-left:4px solid #facc15; }
</style>
</head>

<body>

<div id="topBar">
  <strong>üìä AI Signal Dashboard</strong>

  <select id="dateFilter">
    <option value="all">All</option>
    <option value="today">Today</option>
    <option value="week">This Week</option>
  </select>

  <button id="replayBtn">‚ñ∂ Replay</button>
  <button id="stopBtn">‚èπ Stop</button>

  <span id="stats"></span>
</div>

<div id="signalsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* üî¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyB1G6DhAZv70YLk65ESgZl0Cm1BHzab4a0",
  authDomain: "buddydownloads-72e3b.firebaseapp.com",
  databaseURL: "https://buddydownloads-72e3b-default-rtdb.firebaseio.com",
  projectId: "buddydownloads-72e3b",
  storageBucket: "buddydownloads-72e3b.appspot.com",
  messagingSenderId: "782621240629",
  appId: "1:782621240629:web:4678fac59caad0f3ac707c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let signals = [];
let replayRunning = false;
const symbol = new URLSearchParams(window.location.search).get("symbol")?.replace(/\//g,'').toUpperCase() || "XAUUSD";

const signalsContainer = document.getElementById("signalsContainer");
const statsEl = document.getElementById("stats");
const replayBtn = document.getElementById("replayBtn");
const stopBtn = document.getElementById("stopBtn");

/* =============================== WIN/LOSS CALCULATION =============================== */
function inferWins(signals) {
    if (!signals || signals.length === 0) return [];

    signals.sort((a,b) => new Date(a.time) - new Date(b.time));

    for (let i = 0; i < signals.length; i++) {
        const s = signals[i];
        const next = signals[i+1];

        s.inferredResult = "UNKNOWN";

        if (next && next.symbol === s.symbol) {
            const sPrice = s.entry || s.price || s.close;
            const nextPrice = next.entry || next.price || next.close;
            if (!sPrice || !nextPrice) continue;

            if (s.tp) {
                if (s.type === "BUY" && nextPrice >= s.tp) s.inferredResult = "WIN";
                else if (s.type === "SELL" && nextPrice <= s.tp) s.inferredResult = "WIN";
                else s.inferredResult = "LOSS";
            } else {
                if (s.type === "BUY" && nextPrice > sPrice) s.inferredResult = "WIN";
                else if (s.type === "SELL" && nextPrice < sPrice) s.inferredResult = "WIN";
                else s.inferredResult = "LOSS";
            }
        }
    }

    return signals;
}

/* =============================== FILTER SIGNALS =============================== */
function applyFilter(){
  const f = document.getElementById("dateFilter").value;
  const now = Date.now();
  return signals.filter(s=>{
    const t = new Date(s.time).getTime();
    if(f==="today") return now - t < 86400000;
    if(f==="week") return now - t < 604800000;
    return true;
  });
}

/* =============================== DISPLAY SIGNALS =============================== */
function displaySignals(){
    signalsContainer.innerHTML = "";
    const filtered = applyFilter();
    filtered.forEach(s=>{
        const card = document.createElement("div");
        card.className = `signalCard ${s.type.toLowerCase()} ${s.inferredResult?.toLowerCase()||"unknown"}`;
        card.innerHTML = `
            <strong>${s.symbol} - ${s.type}</strong><br>
            Entry: ${s.entry?.toFixed(2) || s.price?.toFixed(2) || "-"} | SL: ${s.sl?.toFixed(2)||"-"} | TP: ${s.tp?.toFixed(2)||"-"}<br>
            Sent: ${new Date(s.time).toLocaleString()}<br>
            Result: ${s.inferredResult || "UNKNOWN"}
        `;
        signalsContainer.appendChild(card);
    });

    const wins = filtered.filter(s=>s.inferredResult==="WIN").length;
    statsEl.innerText = `Signals: ${filtered.length} | Wins: ${wins}`;
}

/* =============================== FIREBASE LISTENER =============================== */
const signalsRef = ref(db,"signals");
onValue(signalsRef, (snapshot) => {
    if(!snapshot.exists()) return;
    signals = Object.values(snapshot.val())
        .map(s=>({
            ...s,
            type: String(s.type).toUpperCase()
        }))
        .filter(s=>{
            const sSymbol = (s.symbol||"").replace(/\//g,'').toUpperCase();
            return sSymbol === symbol && (s.type==="BUY" || s.type==="SELL");
        })
        .sort((a,b)=>new Date(a.time)-new Date(b.time));

    inferWins(signals);
    if(replayRunning) displaySignals();
});

/* =============================== BUTTONS =============================== */
replayBtn.addEventListener("click", ()=>{
    replayRunning = true;
    displaySignals();
});

stopBtn.addEventListener("click", ()=>{
    replayRunning = false;
});
</script>

</body>
</html>
